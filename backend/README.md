# CAGEChat Backend 

Welcome to CAGEChat Backend Repo. 

This is a project which main objective is to create a first-version RAG System for the Contadoia e Auditoria Geral do Estado do Rio Grande do Sul. 

The system should be able to integrate many documents, inclusive the following ones:

1. Official Guides and Manuals from CAGE Website <a href='https://cage.fazenda.rs.gov.br/lista/564/publicacoes'> Publicações CAGE </a>
2. Federal and Rio Grande do Sul's Laws;
3. legal opinion issued by the State Attorney General's Office (PGE-RS)
4. Main judges from TCE-RS and TJRS


## Architecture 

The backend is divided into two main LangGraph graphs and an API socket generated by FastAPI.

The graphs are present in the backend.modules.graph.py, whereas the API are coded on the backend.server.api.py.

The project is customized by the config.py file (Setting class), following a similar structure from github <a href='https://github.com/truefoundry/cognita'>Cognita</a>. This is a framework that I'm studying (and maybe should be used in next projects).


### chat_graph

The 'chat_graph' is the graph responsible for generating the response for questions. It is based on Harish Neel Architecture example referenced in his course (github: <a href='https://github.com/harishneel1/langgraph'>LangGraph Course</a>), using a ReACT structure:

<img src="docs/chat_graph_image.img" alt="Chat Graph Architecture" width="400"/>


The nodes used are:

- **question_rewriter**: responsible for rewritting the user question, appending all relevant historical chat context for a better document retrieve and question processing. 

- **question_classifier**: responsible for classifying the user question, in order to avoid non-related questions for the system. The CAGEChat should be used only for public affairs, not for a general ask. 

- **off_topic_response**: node responsible for returning the final answer for user when the question isn't related to CAGEChat subjects. 

- **retrieve**: node responsible for retrieving the documents relevant to the question. This node should be updated to a subgraph in the next versions, in order to allow the system to retrieve different documents types and reranking them. 

- **retrieval_grade**: node responsible for verify the significance between the documents retrieved and the user question. It allows to reroute the graph, making it able to rewrite the input of the retrieve node in an attempt of better retrieving the documents. 

- **generate_answer**: node that generate the final answer when there are enough significant document to answer the user's question.

- **cannot_answer**: node that generate the final answer when there aren't enough significant document to answer the user's question. It is routed to after a few attempts to change the question and re-retrieve. 


### upload_graph

The 'upload_graph' is a LangGraph Graph responsible for indexing and saving documents in the VectorStore. It is a secundary, but extreme important, graph for the CAGEChat system. 

Nowadays, it is still basic, using the LangGraph framework in order to embedding and indexing tasks. 


## FastAPI endpoints 

The CAGEChat Backend is used by API endpoints, provided in order to accept a cloud deploy and to allow many nodes (kubernetes).

Although the aim of this project isn't become production-ready, I felt I should use API in order to allow to use this as MVP (when used by a frontend application).

The API endpoints present in this project are:



### GET(/chat_stream/)

This is the main endpoint, where the user/frontend system should send GET requests with the following parameters:

- message: the user's question
- [OPTIONAL] checkpoint_id: the thread id used to allow chat conversation (save checkpoints to the chat)


### POST(/upload_file/)

This is the endpoint used to upload files for the 'upload_graph', accepting the POST requests with the following parameters:

- file: file uploaded in the request
- metadata: json containing the metadata of the file (used to improve the retrieve and the identification of the source). This should have at least the key "tipo_documento", which accepts: "manuais", "leis", "pareceres", "jurisprudência". 



## Contributors:

Please feel free to contribute to this project! 
This is a first attempt to RAG Systems, and still have too many areas to improve.

A few areas of improvement are:

- Insert RAGAS (or other eval framework) to continuous evaluation of the system
- Add NoSQL Databases connection to save the documents (and avoid recreating docs)
- Add unit tests to the system 
- Add evaluation tool in order to optimize the hyperparameters
- Add fine-tuning for models
- Add questions and answers for system evaluation

Let's keep going on! 